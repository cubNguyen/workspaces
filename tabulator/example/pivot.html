<!DOCTYPE html>
<html>
    <head>
        <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet" />
        <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    </head>
    <body>
        <div id="origin-table"></div>
        <br />
        <div id="pivot-table"></div>

        <script>
            var nestedData = [
                {
                    id: 1,
                    make: 'Ford',
                    model: 'focus',
                    reg: 'P232 NJP',
                    color: 'white',
                    serviceHistory: [
                        { date: '01/02/2016', engineer: 'Steve Boberson', actions: 'Changed oli filter' },
                        { date: '07/02/2017', engineer: 'Martin Stevenson', actions: 'Break light broken' },
                    ],
                },
                {
                    id: 1,
                    make: 'BMW',
                    model: 'm3',
                    reg: 'W342 SEF',
                    color: 'red',
                    serviceHistory: [
                        { date: '22/05/2017', engineer: 'Jimmy Brown', actions: 'Aligned wheels' },
                        { date: '11/02/2018', engineer: 'Lotty Ferberson', actions: 'Changed Oil' },
                        { date: '04/04/2018', engineer: 'Franco Martinez', actions: 'Fixed Tracking' },
                    ],
                },
            ];

            var otable = new Tabulator('#origin-table', {
                height: '311px',
                columnDefaults: {
                    resizable: true,
                },
                data: nestedData,
                columns: [
                    { title: 'Make', field: 'make' },
                    { title: 'Model', field: 'model' },
                    { title: 'Registration', field: 'reg' },
                    { title: 'Color', field: 'color' },
                    { title: 'History', field: 'serviceHistory' },
                    { title: 'Date', field: 'serviceHistory.0.date', sorter: 'date' },
                    { title: 'Engineer', field: 'serviceHistory.0.engineer' },
                    {
                        title: 'Action',
                        field: 'serviceHistory.0.actions',
                        editor: true,
                        cellEdited: (cell) => {
                            console.log(cell);
                        },
                    },
                ],
            });

            var ptable = new Tabulator('#pivot-table', {
                height: '311px',
                columnDefaults: {
                    resizable: true,
                },
                data: nestedData,
                columns: [
                    { title: 'Make', field: 'make' },
                    { title: 'Model', field: 'model' },
                    { title: 'Registration', field: 'reg' },
                    { title: 'Color', field: 'color' },
                    { title: 'History', field: 'serviceHistory' },
                    { title: 'Date', field: 'serviceHistory.0.date', sorter: 'date' },
                    { title: 'Engineer', field: 'serviceHistory.0.engineer' },
                    { title: 'Action', field: 'serviceHistory.0.actions' },
                ],
            });

            function formatterWrapper(cell, formatterParams, onRendered) {
                const row = cell.getRow();
                const column = cell.getColumn()._column;
                const options = cell.getTable().options;

                if (
                    !cell._cell.value &&
                    row.getTreeParent() &&
                    column.fieldStructure &&
                    options.dataTreeElementColumn &&
                    column.fieldStructure[0] == options.dataTreeElementColumn &&
                    column.fieldStructure[1] == '0'
                ) {
                    const tempObj = {
                        getFieldValue: column.getFieldValue,
                        fieldStructure: column.fieldStructure.slice(2),
                    };
                    cell._cell.value = tempObj.getFieldValue(row.getData());
                }
                return column.modules.format.originalFormatter.call(this, cell, formatterParams, onRendered);
            }

            function pivotFormatter(cell, formatterParams) {
                const row = cell.getRow();
                const parent = row.getTreeParent();
                if (!parent) return '0';
                return parent.getTreeChildren().indexOf(row);
            }

            function pivot(table, colName) {
                table.on('renderStarted', () => {
                    table.getColumns().forEach((col) => {
                        const format = col._column.modules.format;
                        if (!format.originalFormatter) {
                            format.originalFormatter = col.getField() == colName ? pivotFormatter : format.formatter;
                            format.formatter = formatterWrapper;
                        }
                    });
                });

                table.on('dataTreeRowExpanded', function (row, level) {
                    let child = row.getTreeChildren();
                    if (child && (child = child[0])) child.getElement().style.display = 'none';
                });

                table.options.dataTreeElementColumn = table.options.dataTreeChildField = colName;
                table.options.dataTree = true;
            }
            pivot(ptable, 'serviceHistory');
        </script>
    </body>
</html>
